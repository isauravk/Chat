<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Zoho CRM Gemini Chatbot</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      display: flex; flex-direction: column;
      height: 100vh; width: 100%;
    }
    #chat {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      border-bottom: 1px solid #ccc;
    }
    #inputArea {
      display: flex;
      border-top: 1px solid #ccc;
    }
    #msg {
      flex: 1;
      padding: 10px;
      border: none;
      outline: none;
    }
    #sendBtn {
      padding: 10px 20px;
      border: none;
      background: #0073e6;
      color: white;
      cursor: pointer;
    }
    #sendBtn:hover {
      background: #005bb5;
    }
    .bubble {
      margin: 5px 0;
      padding: 8px 12px;
      border-radius: 10px;
      max-width: 80%;
      word-wrap: break-word;
    }
    .user {
      background: #0073e6;
      color: white;
      align-self: flex-end;
    }
    .bot {
      background: #f1f1f1;
      align-self: flex-start;
    }
  </style>
</head>
<body>
  <div id="chat"></div>
  <div id="inputArea">
    <input id="msg" placeholder="Type a message..." />
    <button id="sendBtn">Send</button>
  </div>

  <script>
    const chatBox = document.getElementById("chat");
    const input = document.getElementById("msg");
    const sendBtn = document.getElementById("sendBtn");

    // ✅ Gemini API Key (keep for testing)
    const API_KEY = "AIzaSyDpuGJvKMOaB3BdcaTY6DitA2yJQdNd6Tc";
    const API_URL =
      "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=" +
      API_KEY;

    // ✅ MCP Server for Zoho CRM
    const MCP_SERVER_URL =
      "https://sweetmeal-phytosociological-connie.ngrok-free.dev";

    // ✅ System Context for Gemini
    const SYSTEM_CONTEXT = `
You are an assistant for Zoho CRM. 
Always return actions as JSON if user asks to create, update, search CRM records.
Available actions: 
- get_module_data
- get_available_modules
- search_records
- create_record
- update_record
- delete_record
- bulk_create_records
- get_record_by_id
`;

    function addMessage(text, sender) {
      const div = document.createElement("div");
      div.classList.add("bubble", sender);
      div.textContent = text;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

async function sendMessage() {
  const userMsg = input.value.trim();
  if (!userMsg) return;
  addMessage(userMsg, "user");
  input.value = "";

  try {
    // 1. Ask Gemini first with SYSTEM_CONTEXT
    const response = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents: [
          { role: "system", parts: [{ text: SYSTEM_CONTEXT }] },
          { role: "user", parts: [{ text: userMsg }] },
        ],
      }),
    });

    const data = await response.json();

    // ✅ Safely extract Gemini reply
    let botReply = "⚠️ No reply";
    if (data?.candidates?.[0]?.content?.parts) {
      botReply = data.candidates[0].content.parts
        .map((p) => p.text || "")
        .join("\n")
        .trim();
    }

    addMessage(botReply, "bot");

    // 2. If Gemini returns JSON → forward to MCP server
    try {
      const maybeAction = JSON.parse(botReply);
      if (maybeAction?.action) {
        const crmResp = await fetch(
          `${MCP_SERVER_URL}/${maybeAction.action}`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(maybeAction.params || {}),
          }
        );

        const crmData = await crmResp.json();
        addMessage(
          `✅ Zoho CRM Response: ${JSON.stringify(crmData)}`,
          "bot"
        );
      }
    } catch (err) {
      // not JSON, ignore
    }
  } catch (err) {
    addMessage("⚠️ Error: " + err.message, "bot");
  }
}


    sendBtn.addEventListener("click", sendMessage);
    input.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendMessage();
    });
  </script>
</body>
</html>

